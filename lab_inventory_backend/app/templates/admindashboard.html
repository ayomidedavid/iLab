<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>iLab — Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet">
  <style>
    /* Gradient sidebar and header using established colours */
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
      color: #fff;
    }
    .sidebar a { color: rgba(255,255,255,0.9); }
    .brand { font-weight: 700; letter-spacing: 1px; }
    .card-gradient {
      background: linear-gradient(135deg, rgba(52,152,219,0.12), rgba(44,62,80,0.06));
      border: none;
    }
    .stat-number { font-size: 1.75rem; font-weight: 700; }
    .muted { color: #6c757d; }
    .activity-log { max-height: 240px; overflow:auto; }
    .table-fixed { max-height:300px; overflow:auto; display:block; }
    .sidebar .nav-link.active { background: rgba(255,255,255,0.08); border-radius:8px; }
    .badge-status { font-size:0.8rem; }
    .notifications { max-height:200px; overflow:auto; }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <nav class="sidebar p-3 col-12 col-md-3 col-lg-2">
      <div class="d-flex align-items-center mb-4">
        <img src="{{ url_for('static', filename='logo.png') }}" class="logo me-2" alt="iLab">
        <div>
          <div class="brand">iLab</div>
          <div class="small">Lab Management</div>
        </div>
      </div>

      <ul class="nav flex-column gap-1">
        <li class="nav-item"><a class="nav-link active" href="#overview">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="#inventory">Inventory</a></li>
        <li class="nav-item"><a class="nav-link" href="#users">Users</a></li>
        <li class="nav-item"><a class="nav-link" href="#sessions">Sessions</a></li>
        <li class="nav-item"><a class="nav-link" href="#maintenance">Maintenance</a></li>
        <li class="nav-item"><a class="nav-link" href="#reports">Reports</a></li>
        <li class="nav-item"><a class="nav-link" href="#settings" data-bs-toggle="modal" data-bs-target="#settingsModal">Settings</a></li>
        <li class="nav-item mt-3"><a class="btn btn-light btn-sm w-100 text-center" href="/signout">Sign out</a></li>
      </ul>
    </nav>

    <!-- Main content -->
    <main class="flex-grow-1 p-4">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="mb-0">Admin Dashboard</h2>
            <div class="muted">Welcome back, {{ current_user.username }} <span class="text-muted">•</span> <small>Administrator</small></div>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <div class="text-end">
              <small class="muted">Current sessions</small>
              <div class="fw-bold">{{ current_sessions or 0 }}</div>
            </div>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addAssetModal">+ Add Desktop</button>
          </div>
        </div>

        <!-- Top stats -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card card-gradient p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="muted">Total Systems</div>
                  <div class="stat-number">{{ total_systems or 0 }}</div>
                </div>
                <div>
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="#3498db"><path d="M3 3h18v4H3zM3 9h18v12H3z"/></svg>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-gradient p-3 shadow-sm">
              <div class="muted">Active</div>
              <div class="stat-number text-success">{{ active_count or 0 }}</div>
              <div class="small muted">Currently running</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-gradient p-3 shadow-sm">
              <div class="muted">Faulty</div>
              <div class="stat-number text-danger">{{ faulty_count or 0 }}</div>
              <div class="small muted">Needs attention</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-gradient p-3 shadow-sm">
              <div class="muted">Under Maintenance</div>
              <div class="stat-number text-warning">{{ maintenance_count or 0 }}</div>
              <div class="small muted">Assigned to technicians</div>
            </div>
          </div>
        </div>

        <!-- Charts & Activity -->
        <div class="row g-4">
          <div class="col-lg-7">
            <div class="card p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">System Status</h5>
                <small class="muted">Real-time overview</small>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <canvas id="statusPie"></canvas>
                </div>
                <div class="col-md-6">
                  <canvas id="usageLine"></canvas>
                </div>
              </div>
            </div>

            <div class="card p-3 mt-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Asset Inventory</h5>
                <div>
                  <button class="btn btn-sm btn-outline-secondary" id="exportCsv">Export CSV</button>
                  <button class="btn btn-sm btn-outline-secondary" id="exportPdf">Export PDF</button>
                </div>
              </div>

              <div class="table-responsive table-fixed mt-2">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light position-sticky top-0">
                    <tr>
                      <th>UUID / Barcode</th>
                      <th>Hostname</th>
                      <th>Location</th>
                      <th>Status</th>
                      <th>Assigned To</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for system in systems[:15] %}
                    <tr>
                      <td>{{ system.uuid }}</td>
                      <td>{{ system.hostname }}</td>
                      <td>{{ system.location }}</td>
                      <td>
                        {% if system.status == 'active' %}
                          <span class="badge bg-success badge-status">Active</span>
                        {% elif system.status == 'faulty' %}
                          <span class="badge bg-danger badge-status">Faulty</span>
                        {% elif system.status == 'maintenance' %}
                          <span class="badge bg-warning text-dark badge-status">Maintenance</span>
                        {% else %}
                          <span class="badge bg-secondary badge-status">{{ system.status }}</span>
                        {% endif %}
                      </td>
                      <td>{{ system.assigned_to or '-' }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary">Edit</button>
                        <button class="btn btn-sm btn-outline-danger">Decommission</button>
                      </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center text-muted">No systems available</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

            </div>
          </div>

          <div class="col-lg-5">
            <div class="card p-3 shadow-sm mb-3">
              <h6>Recent Activity</h6>
              <div class="activity-log list-group list-group-flush mt-2">
                {% for act in recent_activity[:12] %}
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between">
                    <small class="text-muted">{{ act.time }}</small>
                    <small class="muted">{{ act.user }}</small>
                  </div>
                  <div>{{ act.message }}</div>
                </div>
                {% else %}
                <div class="list-group-item text-center text-muted">No recent activity</div>
                {% endfor %}
              </div>
            </div>

            <div class="card p-3 shadow-sm mb-3">
              <h6>Maintenance Queue</h6>
              <ul class="list-group list-group-flush mt-2">
                {% for m in maintenance_list[:8] %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-bold">{{ m.hostname }}</div>
                    <div class="small muted">{{ m.issue_summary }}</div>
                  </div>
                  <div class="text-end">
                    <div><span class="badge bg-warning text-dark">{{ m.status }}</span></div>
                    <div class="small muted">Assigned: {{ m.technician or 'Unassigned' }}</div>
                  </div>
                </li>
                {% else %}
                <li class="list-group-item text-center text-muted">No maintenance items</li>
                {% endfor %}
              </ul>
            </div>

            <div class="card p-3 shadow-sm">
              <h6>Notifications</h6>
              <div class="notifications list-group list-group-flush mt-2">
                {% for note in notifications[:6] %}
                <div class="list-group-item d-flex justify-content-between">
                  <div>{{ note.message }}</div>
                  <small class="muted">{{ note.time }}</small>
                </div>
                {% else %}
                <div class="list-group-item text-center text-muted">No notifications</div>
                {% endfor %}
              </div>
            </div>

          </div>
        </div>

        <!-- Users & Audit -->
        <div class="row g-4 mt-3">
          <div class="col-lg-6">
            <div class="card p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">User & Role Management</h5>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">New User</button>
              </div>
              <div class="table-responsive mt-2 table-fixed">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <form class="d-flex" method="get" action="#" onsubmit="return false;">
                      <input class="form-control form-control-sm me-2" type="search" id="userSearch" placeholder="Search username..." aria-label="Search" oninput="filterUsers()">
                      <select class="form-select form-select-sm me-2" id="roleFilter" onchange="filterUsers()">
                        <option value="">All Roles</option>
                        <option value="Admin">Admin</option>
                        <option value="Technician">Technician</option>
                        <option value="Lecturer">Lecturer</option>
                        <option value="Viewer">Viewer</option>
                        <option value="Student">Student</option>
                      </select>
                    </form>
                  </div>
                  <table class="table table-hover mb-0" id="userTable">
                    <thead class="table-light">
                      <tr><th>Username</th><th>Role</th><th>Status</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="userTableBody">
                      {% for u in users|sort(attribute='role') %}
                      <tr>
                        <td>{{ u.username }}</td>
                        <td>{{ u.role }}</td>
                        <td>{{ u.status or 'active' }}</td>
                        <td>
                          <button class="btn btn-sm btn-outline-secondary">Edit</button>
                          <button class="btn btn-sm btn-outline-danger">Deactivate</button>
                          {% if u.status == 'pending' %}
                            <form method="post" action="/admin/users/approve" style="display:inline">
                              <input type="hidden" name="username" value="{{ u.username }}">
                              <button type="submit" class="btn btn-sm btn-success ms-1">Approve</button>
                            </form>
                          {% endif %}
                        </td>
                      </tr>
                      {% else %}
                      <tr><td colspan="4" class="text-center text-muted">No users</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  <script>
                    function filterUsers() {
                      var searchInput = document.getElementById('userSearch').value.toLowerCase();
                      var selectedRole = document.getElementById('roleFilter').value;
                      var rows = document.querySelectorAll('#userTableBody tr');
                      rows.forEach(function(row) {
                        var username = row.cells[0].textContent.toLowerCase();
                        var role = row.cells[1].textContent;
                        var matchesSearch = username.includes(searchInput);
                        var matchesRole = (!selectedRole || role === selectedRole);
                        row.style.display = (matchesSearch && matchesRole) ? '' : 'none';
                      });
                    }
                  </script>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Audit & Security</h5>
                <small class="muted">Last 24 hours</small>
              </div>
              <div class="table-responsive table-fixed mt-2">
                <table class="table table-sm mb-0">
                  <thead class="table-light"><tr><th>Time</th><th>User</th><th>Action</th></tr></thead>
                  <tbody>
                    {% for a in audit_logs[:12] %}
                    <tr>
                      <td>{{ a.time }}</td>
                      <td>{{ a.user }}</td>
                      <td>{{ a.action }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">No audit logs</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="addAssetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Desktop</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/admin/assets/add">
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">UUID / Barcode</label>
                <input name="uuid" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Hostname</label>
                <input name="hostname" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Location</label>
                <input name="location" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Category</label>
                <select name="status" class="form-select">
                  <option value="working">Working</option>
                  <option value="faulty">Faulty</option>
                  <option value="reserved">Reserved</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Desktop</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/admin/users/add">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input name="username" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" name="email" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Role</label>
              <select name="role" class="form-select">
                <option>Admin</option>
                <option>Technician</option>
                <option>Lecturer</option>
                <option>Viewer</option>
                <option>Student</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" name="password" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create User</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">System Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/admin/settings">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Application Name</label>
              <input name="app_name" class="form-control" value="iLab">
            </div>
            <div class="mb-3">
              <label class="form-label">Upload Logo (place in /static)</label>
              <input type="text" class="form-control" name="logo_path" placeholder="logo.png">
            </div>
            <div class="mb-3">
              <label class="form-label">Session Timeout (minutes)</label>
              <input name="session_timeout" class="form-control" value="30">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Dashboard data (server-provided) -->
  <div id="dashboard-data" style="display:none"
       data-active="{{ active_count|default(10) }}"
       data-faulty="{{ faulty_count|default(2) }}"
       data-maintenance="{{ maintenance_count|default(3) }}"
       data-usage-labels='{{ usage_labels|default(["6h","5h","4h","3h","2h","1h","Now"])|tojson }}'
       data-usage-series='{{ usage_series|default([2,3,5,4,6,7, (active_count|default(10))])|tojson }}'>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Read server-provided values from data attributes to avoid embedding Jinja directly in JS
    const dataEl = document.getElementById('dashboard-data');
    const active = Number(dataEl.dataset.active) || 0;
    const faulty = Number(dataEl.dataset.faulty) || 0;
    const maintenance = Number(dataEl.dataset.maintenance) || 0;
    const usageLabels = JSON.parse(dataEl.dataset.usageLabels || '[]');
    const usageSeries = JSON.parse(dataEl.dataset.usageSeries || '[]');

    const statusData = [active, faulty, maintenance];

    // Pie chart for status
    const ctxPie = document.getElementById('statusPie');
    if (ctxPie) {
      new Chart(ctxPie, {
        type: 'doughnut',
        data: {
          labels: ['Active','Faulty','Maintenance'],
          datasets: [{
            data: statusData,
            backgroundColor: ['#2ecc71','#e74c3c','#f1c40f']
          }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    // Line chart for recent usage
    const ctxLine = document.getElementById('usageLine');
    if (ctxLine) {
      new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: usageLabels.length ? usageLabels : ['6h','5h','4h','3h','2h','1h','Now'],
          datasets: [{
            label: 'Active sessions',
            data: usageSeries.length ? usageSeries : [2,3,5,4,6,7, active],
            borderColor: '#3498db',
            backgroundColor: 'rgba(52,152,219,0.15)',
            fill: true,
            tension: 0.3
          }]
        },
        options: { scales: { y: { beginAtZero:true } }, plugins: { legend: { display:false } } }
      });
    }

    // Export buttons (placeholders)
    document.getElementById('exportCsv')?.addEventListener('click', ()=> alert('Export CSV - implement server-side'));
    document.getElementById('exportPdf')?.addEventListener('click', ()=> alert('Export PDF - implement server-side'));
  </script>
</body>
</html>
